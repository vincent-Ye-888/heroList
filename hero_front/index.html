<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è‹±é›„ç®¡ç†ä¸»é¡µ</title>
    <link rel="stylesheet" href="./lib/bootstrap/css/bootstrap.min.css" />
    <style>
        .panel {
            width: 900px;
            margin: 10px auto;
        }

        .table img {
            width: 40px;
            height: 40px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="panel panel-primary">
            <!-- Default panel contents -->
            <div class="panel-heading">è‹±é›„åˆ—è¡¨ç®¡ç†</div>
            <div class="panel-body">
                <!-- å­˜æ”¾çš„æœç´¢åŒºåŸŸ -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="input-group">
                            <input type="text" id="hname" class="form-control" placeholder="è¾“å…¥è‹±é›„ä¿¡æ¯..." />
                            <span class="input-group-btn">
                                <button class="btn btn-default" id="btn_search" type="button">æœç´¢</button>
                            </span>
                        </div>
                        <!-- /input-group -->
                    </div>
                    <!-- /.col-lg-6 -->
                    <div class="col-lg-3 col-lg-offset-3">
                        <!-- æ·»åŠ è‹±é›„çš„æŒ‰é’® -->
                        <!-- 
                            ğŸ§¨è°ƒç”¨æ¨¡æ€æ¡†çš„ä¸¤ä¸ªå±æ€§ï¼š
                            data-toggle="modal"                 ğŸ§¨ è°ƒç”¨åˆ‡æ¢æ¨¡æ€æ¡†åŠŸèƒ½
                            data-target="#exampleModal"         ğŸ§¨ è¦è°ƒç”¨å“ªä¸ªæ¨¡æ€æ¡†
                        -->
                        <button data-toggle="modal" data-target="#exampleModal" type="button" class="btn btn-success">
                            æ·»åŠ è‹±é›„
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <table class="table">
                <thead>
                    <tr>
                        <th>ç¼–å·</th>
                        <th>è‹±é›„åç§°</th>
                        <th>è‹±é›„æ€§åˆ«</th>
                        <th>å¤´åƒ</th>
                        <th>æ“ä½œåŒº</th>
                    </tr>
                </thead>
                <!-- è¡¨æ ¼ä¸»ä½“ -->
                <tbody id="tbody">
                    <!-- tr æ˜¯ä¸€è¡Œå†…å®¹ -->
                    <tr>
                        <td>1</td>
                        <td>å¤§ä¹”</td>
                        <td>å¥³</td>
                        <td><img src="" /></td>
                        <td>
                            <button type="button" class="btn btn-warning">ä¸Šä¼ å¤´åƒ</button>
                            <button type="button" class="btn btn-danger">åˆ é™¤</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- ä¸Šä¼ æŒ‰é’®  display: none; æŠŠæŒ‰é’®éšè—èµ·æ¥ï¼Œä½†æ˜¯ç‚¹å‡»æŒ‰é’®è¿˜æ˜¯å¯ä»¥å®ç°ä¸Šä¼ çš„ -->
        <input type="file" id="uploadFile" style="display: none" />

        <!-- ğŸ§¨æ¨¡æ€æ¡†çš„ç»“æ„ - CVè¿‡æ¥çš„ -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="exampleModalLabel">æ·»åŠ è‹±é›„</h4>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="recipient-name" class="control-label">è‹±é›„åç§°:</label>
                                <input type="text" placeholder="è¯·è¾“å…¥è‹±é›„åç§°" class="form-control" id="heroName" />
                            </div>
                            <div class="form-group">
                                <label for="message-text" class="control-label">è‹±é›„æ€§åˆ«:</label>
                                <label><input type="radio" checked value="ç”·" name="gender" /> ğŸ‘¦ç”·ç”Ÿ</label>
                                <label><input type="radio" value="å¥³" name="gender" /> ğŸ‘©â€ğŸ¦°å¥³ç”Ÿ</label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">å…³é—­</button>
                        <button id="addHeroBtn" type="button" class="btn btn-primary">æ·»åŠ </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ§¨ å¿…é¡»å…ˆå¼•å…¥ jquery.js å†å¼•å…¥ bootstrap.js -->
    <script src="./lib/jquery/jquery.min.js"></script>
    <script src="./lib/bootstrap/js/bootstrap.js"></script>
    <script>
        //ä¸ºajaxè¯·æ±‚ç»Ÿä¸€åŠ ä¸Štokenè¯·æ±‚å¤´
        $.ajaxSetup({
            //åœ¨å‘è¯·æ±‚æ—¶,å¸¦ä¸Štoken
            headers:{ Authorization:localStorage.getItem('token') },
        })

        //å¤šæ¬¡è°ƒç”¨è·å–æ‰€æœ‰è‹±é›„çš„æ•°æ®çš„è¿™ä¸ªå‡½æ•°,æ‰€ä»¥å°è£…èµ·æ¥
        function getHeroList(){
            $.ajax({
                url:'http://127.0.0.1:4444/hero/getHeroList',
                type:'GET',
                data:{ 
                    heroName:$('#hname').val().trim(),
                },
                dataType:'json',
                success:(res)=>{
                    // console.log(res);
                    //å­—ç¬¦ä¸²æ‹¼æ¥
                    let htmlStr = '';
                    res.data.forEach((item)=>{
                        htmlStr += `
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.name}</td>
                            <td>${item.gender}</td>
                            <td><img src="${item.img}" /></td>
                            <td>
                                <button data-id="${item.id}" type="button" class="btn btn-warning">ä¸Šä¼ å¤´åƒ</button>
                                <button data-id="${item.id}" type="button" class="btn btn-danger">åˆ é™¤</button>
                            </td>
                        </tr>
                        `
                        //åœ¨tbodyä¸­è‡ªåŠ¨ç”Ÿæˆ
                        $('#tbody').html(htmlStr)
                    })
                }
            })
        }
        //æœç´¢
        $('#btn_search').click(function(){
            getHeroList();
        })
        //æ·»åŠ 
        $('#addHeroBtn').click(function(){
            $.ajax({
                url:'http://localhost:4444/hero/addHero',
                type:'post',
                data:{ 
                    name:$('#heroName').val().trim(),
                    gender:$('[name="gender"]:checked').val()   // ç”¨$æ¥è·å–å•é€‰æŒ‰é’®ä¸­é€‰ä¸­çš„å€¼
                },
                dataType:'json',
                success:(res)=>{
                    // console.log(res);
                    //æˆåŠŸåè¦éšè—æ¨¡æ€æ¡†
                    if(res.code === 200){
                        $('#exampleModal').modal('hide')
                        //é‡æ–°æ¸²æŸ“é¡µé¢
						getHeroList()
                    }

                }
            })
        })
        //åˆ é™¤
        $('#tbody').on('click', '.btn-danger', function (){
            $.ajax({
                url:'http://127.0.0.1:4444/hero/delHeroById',
                type:'GET',
                data:{ id:$(this).attr('data-id') },
                dataType:'json',
                success:(res)=>{
                    // console.log(res);
                    if(res.code === 200){
                        alert(res.msg)
                        getHeroList();
                    }
                }
            })
        })

        $(function(){
            //é¡µé¢ä¸€å¼€å°±è¦è°ƒç”¨å‡½æ•°,æ¸²æŸ“æœ‰é¡µé¢
            getHeroList();

            let curId = '';
            //ç»™ä¸Šä¼ å¤´åƒ æ·»åŠ äº‹ä»¶å§”æ‰˜  -- å› ä¸ºè‹±é›„æ•°æ®æ˜¯åŠ¨æ€ç”Ÿæˆçš„,æ‰€ä»¥è¦é€šè¿‡å§”æ‰˜ç»™ä¸Šä¼ æŒ‰é’®ç»‘å®šäº‹ä»¶
            $('#tbody').on('click', '.btn-warning', function () {
				// console.log('ä¸Šä¼ å¤´åƒ')
				// 1. æ¨¡æ‹Ÿæ–‡ä»¶åŸŸè¢«ç‚¹å‡»
				$('#uploadFile').click()

				// 2. å–å‡ºidå€¼,ä¿å­˜ä¸€ä¸‹
				curId = $(this).attr('data-id')
				// alert( $(this).attr('data-id') )
			})
            // æ–‡ä»¶åŸŸ ç”¨æˆ·ç‚¹äº†ç¡®å®š
			// å…ˆåšä¸Šä¼ ï¼Œå†åšæ›´æ–°
            $('#uploadFile').change(function(){
                // console.log(1);
                // thisè¡¨ç¤ºå½“å‰çš„æ–‡ä»¶åŸŸ
				// ç”¨æˆ·é€‰ä¸­çš„æ–‡ä»¶åœ¨ this.files[0]
                const file = this.files[0];
                //å¦‚æœç”¨æˆ·æ²¡æœ‰é€‰ä¸­
                if(!file){
                    return
                }
                //åšæ–‡ä»¶ä¸Šä¼ 
                const fd = new FormData();
                fd.append('file_data',file)
                fd.append("id",curId)
                // console.log(1);
                // $.ajax({
                //     url:'http://localhost:4444/hero/uploadFile',
                //     type:'post',
                //     data:fd,
                //     contentType:false,
                //     processData:false,
                //     success:(res)=>{
                //         console.log(res);
                //     }
                // })
                $.ajax({
                    url:'http://localhost:4444/hero/uploadFile',
                    type:'POST',
                    data: fd,
                    processData: false, // æ— éœ€ jq å¤„ç†æ•°æ®
					contentType: false, // æ— éœ€ jq å¤„ç†å†…å®¹ç±»å‹
                    dataType:'json',
                    success:(res)=>{
                        console.log(1);
                        console.log(res);
                        if(res.code === 200){
                            //ç”¨æˆ·å¤´åƒåœ°å€
                            const imgUrl = res.src

                            // curId // è‹±é›„id
							// å†è°ƒç”¨æ¥å£ï¼Œä¿®æ”¹è‹±é›„å¤´åƒä¿¡æ¯
                            $.ajax({
								url: 'http://localhost:3000/hero/updateHero',
								method: 'POST',
								data: {
									id: curId,
									img: imgUrl
								},
								success: res => {
									console.log('æ›´æ–°å¤´åƒåçš„ç»“æœ', res)
									if (res.code === 200) {
										getHeroList()
									}
								}
							})
                        }
                    }
                })
            })

        })
        //åœ¨å‰ç«¯ç»Ÿä¸€å¤„ç†401é”™è¯¯
        $(document).ajaxError(function( event, request, settings ){
            if(request.status === 401){
                alert('æ²¡æœ‰æƒé™');
                // alert(request.responseJSON.msg)
                location.href = "./login.html";
                return
            }
        })
    </script>
</body>

</html>