<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ëã±ÈõÑÁÆ°ÁêÜ‰∏ªÈ°µ</title>
    <link rel="stylesheet" href="./lib/bootstrap/css/bootstrap.min.css" />
    <style>
        .panel {
            width: 900px;
            margin: 10px auto;
        }

        .table img {
            width: 40px;
            height: 40px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="panel panel-primary">
            <!-- Default panel contents -->
            <div class="panel-heading">Ëã±ÈõÑÂàóË°®ÁÆ°ÁêÜ</div>
            <div class="panel-body">
                <!-- Â≠òÊîæÁöÑÊêúÁ¥¢Âå∫Âüü -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="input-group">
                            <input type="text" id="hname" class="form-control" placeholder="ËæìÂÖ•Ëã±ÈõÑ‰ø°ÊÅØ..." />
                            <span class="input-group-btn">
                                <button class="btn btn-default" id="btn_search" type="button">ÊêúÁ¥¢</button>
                            </span>
                        </div>
                        <!-- /input-group -->
                    </div>
                    <!-- /.col-lg-6 -->
                    <div class="col-lg-3 col-lg-offset-3">
                        <!-- Ê∑ªÂä†Ëã±ÈõÑÁöÑÊåâÈíÆ -->
                        <!-- 
                            üß®Ë∞ÉÁî®Ê®°ÊÄÅÊ°ÜÁöÑ‰∏§‰∏™Â±ûÊÄßÔºö
                            data-toggle="modal"                 üß® Ë∞ÉÁî®ÂàáÊç¢Ê®°ÊÄÅÊ°ÜÂäüËÉΩ
                            data-target="#exampleModal"         üß® Ë¶ÅË∞ÉÁî®Âì™‰∏™Ê®°ÊÄÅÊ°Ü
                        -->
                        <button data-toggle="modal" data-target="#exampleModal" type="button" class="btn btn-success">
                            Ê∑ªÂä†Ëã±ÈõÑ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <table class="table">
                <thead>
                    <tr>
                        <th>ÁºñÂè∑</th>
                        <th>Ëã±ÈõÑÂêçÁß∞</th>
                        <th>Ëã±ÈõÑÊÄßÂà´</th>
                        <th>Â§¥ÂÉè</th>
                        <th>Êìç‰ΩúÂå∫</th>
                    </tr>
                </thead>
                <!-- Ë°®Ê†º‰∏ª‰Ωì -->
                <tbody id="tbody">
                    <!-- tr ÊòØ‰∏ÄË°åÂÜÖÂÆπ -->
                    <tr>
                        <td>1</td>
                        <td>Â§ß‰πî</td>
                        <td>Â•≥</td>
                        <td><img src="" /></td>
                        <td>
                            <button type="button" class="btn btn-warning">‰∏ä‰º†Â§¥ÂÉè</button>
                            <button type="button" class="btn btn-danger">Âà†Èô§</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- ‰∏ä‰º†ÊåâÈíÆ  display: none; ÊääÊåâÈíÆÈöêËóèËµ∑Êù•Ôºå‰ΩÜÊòØÁÇπÂáªÊåâÈíÆËøòÊòØÂèØ‰ª•ÂÆûÁé∞‰∏ä‰º†ÁöÑ -->
        <input type="file" id="uploadFile" style="display: none" />

        <!-- üß®Ê®°ÊÄÅÊ°ÜÁöÑÁªìÊûÑ - CVËøáÊù•ÁöÑ -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="exampleModalLabel">Ê∑ªÂä†Ëã±ÈõÑ</h4>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="recipient-name" class="control-label">Ëã±ÈõÑÂêçÁß∞:</label>
                                <input type="text" placeholder="ËØ∑ËæìÂÖ•Ëã±ÈõÑÂêçÁß∞" class="form-control" id="heroName" />
                            </div>
                            <div class="form-group">
                                <label for="message-text" class="control-label">Ëã±ÈõÑÊÄßÂà´:</label>
                                <label><input type="radio" checked value="Áî∑" name="gender" /> üë¶Áî∑Áîü</label>
                                <label><input type="radio" value="Â•≥" name="gender" /> üë©‚Äçü¶∞Â•≥Áîü</label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">ÂÖ≥Èó≠</button>
                        <button id="addHeroBtn" type="button" class="btn btn-primary">Ê∑ªÂä†</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üß® ÂøÖÈ°ªÂÖàÂºïÂÖ• jquery.js ÂÜçÂºïÂÖ• bootstrap.js -->
    <script src="./lib/jquery/jquery.min.js"></script>
    <script src="./lib/bootstrap/js/bootstrap.js"></script>
    <script>
        //‰∏∫ajaxËØ∑Ê±ÇÁªü‰∏ÄÂä†‰∏ätokenËØ∑Ê±ÇÂ§¥
        $.ajaxSetup({
            //Âú®ÂèëËØ∑Ê±ÇÊó∂,Â∏¶‰∏ätoken
            headers:{ Authorization:localStorage.getItem('token') },
        })

        //Â§öÊ¨°Ë∞ÉÁî®Ëé∑ÂèñÊâÄÊúâËã±ÈõÑÁöÑÊï∞ÊçÆÁöÑËøô‰∏™ÂáΩÊï∞,ÊâÄ‰ª•Â∞ÅË£ÖËµ∑Êù•
        function getHeroList(){
            $.ajax({
                url:'http://127.0.0.1:4444/hero/getHeroList',
                type:'GET',
                data:{ 
                    heroName:$('#hname').val().trim(),
                },
                dataType:'json',
                success:(res)=>{
                    // console.log(res);
                    //Â≠óÁ¨¶‰∏≤ÊãºÊé•
                    let htmlStr = '';
                    res.data.forEach((item)=>{
                        htmlStr += `
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.name}</td>
                            <td>${item.gender}</td>
                            <td><img src="${item.img}" /></td>
                            <td>
                                <button data-id="${item.id}" type="button" class="btn btn-warning">‰∏ä‰º†Â§¥ÂÉè</button>
                                <button data-id="${item.id}" type="button" class="btn btn-danger">Âà†Èô§</button>
                            </td>
                        </tr>
                        `
                        //Âú®tbody‰∏≠Ëá™Âä®ÁîüÊàê
                        $('#tbody').html(htmlStr)
                    })
                }
            })
        }
        //ÊêúÁ¥¢
        $('#btn_search').click(function(){
            getHeroList();
        })
        //Ê∑ªÂä†
        $('#addHeroBtn').click(function(){
            $.ajax({
                url:'http://localhost:4444/hero/addHero',
                type:'post',
                data:{ 
                    name:$('#heroName').val().trim(),
                    gender:$('[name="gender"]:checked').val()   // Áî®$Êù•Ëé∑ÂèñÂçïÈÄâÊåâÈíÆ‰∏≠ÈÄâ‰∏≠ÁöÑÂÄº
                },
                dataType:'json',
                success:(res)=>{
                    // console.log(res);
                    //ÊàêÂäüÂêéË¶ÅÈöêËóèÊ®°ÊÄÅÊ°Ü
                    if(res.code === 200){
                        $('#exampleModal').modal('hide')
                        //ÈáçÊñ∞Ê∏≤ÊüìÈ°µÈù¢
						getHeroList()
                    }

                }
            })
        })
        //Âà†Èô§
        $('#tbody').on('click', '.btn-danger', function (){
            $.ajax({
                url:'http://127.0.0.1:4444/hero/delHeroById',
                type:'GET',
                data:{ id:$(this).attr('data-id') },
                dataType:'json',
                success:(res)=>{
                    // console.log(res);
                    if(res.code === 200){
                        alert(res.msg)
                        getHeroList();
                    }
                }
            })
        })

        $(function(){
            //È°µÈù¢‰∏ÄÂºÄÂ∞±Ë¶ÅË∞ÉÁî®ÂáΩÊï∞,Ê∏≤ÊüìÊúâÈ°µÈù¢
            getHeroList();

            let curId = '';
            //Áªô‰∏ä‰º†Â§¥ÂÉè Ê∑ªÂä†‰∫ã‰ª∂ÂßîÊâò  -- Âõ†‰∏∫Ëã±ÈõÑÊï∞ÊçÆÊòØÂä®ÊÄÅÁîüÊàêÁöÑ,ÊâÄ‰ª•Ë¶ÅÈÄöËøáÂßîÊâòÁªô‰∏ä‰º†ÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂
            $('#tbody').on('click', '.btn-warning', function () {
				// console.log('‰∏ä‰º†Â§¥ÂÉè')
				// 1. Ê®°ÊãüÊñá‰ª∂ÂüüË¢´ÁÇπÂáª
				$('#uploadFile').click()

				// 2. ÂèñÂá∫idÂÄº,‰øùÂ≠ò‰∏Ä‰∏ã
				curId = $(this).attr('data-id')
				// alert( $(this).attr('data-id') )
			})
            // Êñá‰ª∂Âüü Áî®Êà∑ÁÇπ‰∫ÜÁ°ÆÂÆö
			// ÂÖàÂÅö‰∏ä‰º†ÔºåÂÜçÂÅöÊõ¥Êñ∞
            $('#uploadFile').change(function(){
                // console.log(1);
                // thisË°®Á§∫ÂΩìÂâçÁöÑÊñá‰ª∂Âüü
				// Áî®Êà∑ÈÄâ‰∏≠ÁöÑÊñá‰ª∂Âú® this.files[0]
                const file = this.files[0];
                //Â¶ÇÊûúÁî®Êà∑Ê≤°ÊúâÈÄâ‰∏≠
                if(!file){
                    return
                }
                //ÂÅöÊñá‰ª∂‰∏ä‰º†
                const fd = new FormData();
                fd.append('file_data',file)
                fd.append("id",curId)
                // console.log(1);
                // $.ajax({
                //     url:'http://localhost:4444/hero/uploadFile',
                //     type:'post',
                //     data:fd,
                //     contentType:false,
                //     processData:false,
                //     success:(res)=>{
                //         console.log(res);
                //     }
                // })
                $.ajax({
                    url:'http://localhost:4444/hero/uploadFile',
                    type:'POST',
                    data: fd,
                    processData: false, // Êó†ÈúÄ jq Â§ÑÁêÜÊï∞ÊçÆ
					contentType: false, // Êó†ÈúÄ jq Â§ÑÁêÜÂÜÖÂÆπÁ±ªÂûã
                    dataType:'json',
                    success:(res)=>{
                        console.log(1);
                        console.log(res);
                        if(res.code === 200){
                            //Áî®Êà∑Â§¥ÂÉèÂú∞ÂùÄ
                            const imgUrl = res.src

                            // curId // Ëã±ÈõÑid
							// ÂÜçË∞ÉÁî®Êé•Âè£Ôºå‰øÆÊîπËã±ÈõÑÂ§¥ÂÉè‰ø°ÊÅØ
                            $.ajax({
								url: 'http://localhost:3000/hero/updateHero',
								method: 'POST',
								data: {
									id: curId,
									img: imgUrl
								},
								success: res => {
									console.log('Êõ¥Êñ∞Â§¥ÂÉèÂêéÁöÑÁªìÊûú', res)
									if (res.code === 200) {
										getHeroList()
									}
								}
							})
                        }
                    }
                })
            })

        })
        //Âú®ÂâçÁ´ØÁªü‰∏ÄÂ§ÑÁêÜ401ÈîôËØØ
        $(document).ajaxError(function( event, request, settings ){
            if(request.status === 401){
                alert('Ê≤°ÊúâÊùÉÈôê');
                // alert(request.responseJSON.msg)
                location.href = "./login.html";
                return
            }
        })
    </script>
</body>

</html>